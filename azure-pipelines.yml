# azure-pipelines.yml
trigger:
  branches:
    include:
      - dev
      - main

variables:
  buildConfiguration: 'Release'
  dotnetVersion: '8.0.x'
  # Giữ nguyên các biến như bạn đang dùng
  azureServiceConnection: 'ServiceConnection_RestAPI_FarmTimeManagement'
  webAppName: 'flindersdevops'
  # Chưa dùng slot, nhưng giữ lại biến nếu sau này cần
  webAppSlot: 'staging'

pool:
  name: 'SelfHosted_Agent_Tom'

stages:
# ===================== BUILD =====================
- stage: Build
  displayName: Build & Test & Package
  jobs:
  - job: Build
    steps:
    - task: UseDotNet@2
      displayName: 'Use .NET SDK $(dotnetVersion)'
      inputs:
        packageType: 'sdk'
        version: '$(dotnetVersion)'

    - task: DotNetCoreCLI@2
      displayName: Restore
      inputs:
        command: 'restore'
        projects: '**/*.sln'

    - task: DotNetCoreCLI@2
      displayName: Build
      inputs:
        command: 'build'
        projects: '**/*.sln'
        arguments: '--configuration $(buildConfiguration)'
        publishWebProjects: false

    - task: DotNetCoreCLI@2
      displayName: Test
      inputs:
        command: 'test'
        projects: '**/*Tests/*.csproj'
        arguments: '--configuration $(buildConfiguration) --collect "XPlat Code Coverage"'
      continueOnError: true

    - task: DotNetCoreCLI@2
      displayName: Publish (dotnet publish)
      inputs:
        command: 'publish'
        publishWebProjects: true
        arguments: '--configuration $(buildConfiguration) --output $(Build.ArtifactStagingDirectory)'

    - task: ArchiveFiles@2
      displayName: Zip published output
      inputs:
        rootFolderOrFile: '$(Build.ArtifactStagingDirectory)'
        includeRootFolder: false
        archiveType: 'zip'
        archiveFile: '$(Build.ArtifactStagingDirectory)/webapp.zip'

    - publish: '$(Build.ArtifactStagingDirectory)/webapp.zip'
      displayName: 'Publish artifact'
      artifact: 'drop'

# ===================== DEPLOY PRODUCTION =====================
- stage: Deploy_Prod
  displayName: Deploy to Production
  dependsOn: Build
  # Chạy khi build thành công VÀ (push vào main HOẶC PR target main)
  condition: >
    and(
      succeeded(),
      or(
        eq(variables['Build.SourceBranch'], 'refs/heads/main'),
        and(
          eq(variables['Build.Reason'], 'PullRequest'),
          eq(variables['System.PullRequest.TargetBranch'], 'refs/heads/main')
        )
      )
    )
  jobs:
  - deployment: DeployProd
    environment: 'prod'
    strategy:
      runOnce:
        deploy:
          steps:
          - task: DownloadPipelineArtifact@2
            inputs:
              artifact: 'drop'
              path: '$(Pipeline.Workspace)/drop'

          # In biến để debug nếu còn bị skip (tuỳ chọn)
          - powershell: |
              Write-Host "Build.SourceBranch              = $(Build.SourceBranch)"
              Write-Host "Build.Reason                    = $(Build.Reason)"
              Write-Host "System.PullRequest.TargetBranch = $(System.PullRequest.TargetBranch)"
              Write-Host "Package path                    = $(Pipeline.Workspace)\drop\webapp.zip"
            displayName: 'Print branch variables'

          - task: AzureWebApp@1
            displayName: 'Deploy to $(webAppName) - production'
            inputs:
              azureSubscription: '$(azureServiceConnection)'
              appName: '$(webAppName)'
              package: '$(Pipeline.Workspace)/drop/webapp.zip'
              # KHÔNG cấu hình deployToSlotOrASE/slotName -> mặc định deploy Production
